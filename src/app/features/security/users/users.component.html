<div class="users-container">
  <mat-toolbar color="primary">
    <span>{{ 'security.users.title' | translate}}</span>
    <span class="spacer"></span>

    <button mat-raised-button color="accent"
            (click)="openAddDialog()"
            [disabled]="!canCreateUser"
    >
      <mat-icon>add</mat-icon>
      {{ 'security.users.add-user' | translate }}
    </button>
  </mat-toolbar>

  <!-- Loading Spinner -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  }

  <!-- Users Table -->
  @if (!isLoading) {
    <div class="table-container">
      <table mat-table [dataSource]="users" class="mat-elevation-z2">

        <!-- ID Column -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef class="id-column">
            {{ 'security.users.id' | translate }}
          </th>
          <td mat-cell *matCellDef="let user" class="id-column">
            {{ user.id }}
          </td>
        </ng-container>

        <!-- Username Column -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef class="username-column">
            {{ 'security.users.username' | translate }}
          </th>
          <td mat-cell *matCellDef="let user" class="username-column">
            {{ user.username }}
          </td>
        </ng-container>

        <!-- Full Name Column -->
        <ng-container matColumnDef="fullName">
          <th mat-header-cell *matHeaderCellDef class="fullName-column">
            {{ 'security.users.fullName' | translate }}
          </th>
          <td mat-cell *matCellDef="let user" class="fullName-column">
            {{ user.fullName }}
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef class="email-column">
            {{ 'security.users.email' | translate }}
          </th>
          <td mat-cell *matCellDef="let user" class="email-column">
            {{ user.email }}
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef class="status-column">
            {{ 'security.users.status' | translate }}
          </th>
          <td mat-cell *matCellDef="let user" class="status-column">
            {{ user.status }}
          </td>
        </ng-container>

        <!-- Roles Column -->
        <ng-container matColumnDef="roles">
          <th mat-header-cell *matHeaderCellDef class="roles-column">
            {{ 'security.users.roles' | translate }}
          </th>
<!--          <td mat-cell *matCellDef="let user" class="roles-column">-->
<!--            {{ user.roles }}-->
<!--          </td> -->
          <td mat-cell *matCellDef="let user" class="roles-column">
            {{ formatRoles(user) }}
          </td>


        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>
            {{ 'common.actions' | translate }}
          </th>

<!--          <td mat-cell *matCellDef="let user">-->
<!--            &lt;!&ndash; Edit &ndash;&gt;-->
<!--&lt;!&ndash;            <button&ndash;&gt;-->
<!--&lt;!&ndash;              mat-icon-button&ndash;&gt;-->
<!--&lt;!&ndash;              color="primary"&ndash;&gt;-->
<!--&lt;!&ndash;              (click)="editRole(role)"&ndash;&gt;-->
<!--&lt;!&ndash;              [matTooltip]="'common.edit' | translate">&ndash;&gt;-->
<!--&lt;!&ndash;              <mat-icon>edit</mat-icon>&ndash;&gt;-->
<!--&lt;!&ndash;            </button>&ndash;&gt;-->

<!--            &lt;!&ndash; Remove &ndash;&gt;-->
<!--            <button-->
<!--              mat-icon-button-->
<!--              color="warn"-->
<!--              (click)="removeUser(user)"-->
<!--              [disabled]="!canDeleteUser"-->
<!--              [matTooltip]="'common.delete' | translate">-->
<!--              <mat-icon>delete</mat-icon>-->
<!--            </button>-->
<!--          </td>-->

          <td mat-cell *matCellDef="let user">

            <!-- Edit -->
            <button
              mat-icon-button
              color="primary"
              (click)="openEditDialog(user)"
              [disabled]="!canUpdateUser"
              [matTooltip]="'common.edit' | translate">
              <mat-icon>edit</mat-icon>
            </button>

            <!-- Remove -->
            <button
              mat-icon-button
              color="warn"
              (click)="removeUser(user)"
              [disabled]="!canDeleteUser"
              [matTooltip]="'common.delete' | translate">
              <mat-icon>delete</mat-icon>
            </button>
          </td>

        </ng-container>


        <!-- Header and Row Definitions -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>
    </div>
  }

  @if (isDialogOpen) {
    <div class="dialog-overlay" (click)="closeDialog()">
      <mat-card class="dialog-card" (click)="$event.stopPropagation()">
        <mat-card-header class="dialog-header">
<!--          <mat-card-title>-->
<!--            {{ 'security.users.add-user' | translate }}-->
<!--          </mat-card-title>-->
          <mat-card-title>
            {{ editingUserId ? ('common.edit' | translate) : ('security.users.add-user' | translate) }}
          </mat-card-title>

        </mat-card-header>

        <mat-card-content>
          <form [formGroup]="userForm" (ngSubmit)="saveUser()">

            <!-- Username -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'security.users.username' | translate }}</mat-label>
              <input matInput formControlName="username" required>
              @if (userForm.get('username')?.hasError('required')) {
                <mat-error>Username is required</mat-error>
              }
            </mat-form-field>

            <!-- Full Name -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'security.users.fullName' | translate }}</mat-label>
              <input matInput formControlName="fullName" required>
            </mat-form-field>

            <!-- Email -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'security.users.email' | translate }}</mat-label>
              <input matInput formControlName="email" required>
              @if (userForm.get('email')?.hasError('email')) {
                <mat-error>Invalid email</mat-error>
              }
            </mat-form-field>

<!--            &lt;!&ndash; One-Time Password with toggle &ndash;&gt;-->
<!--            <mat-form-field appearance="outline" class="full-width">-->
<!--              <mat-label>{{ 'security.users.one-time-password' | translate }}</mat-label>-->
<!--              <input matInput-->
<!--                     [type]="hidePassword ? 'password' : 'text'"-->
<!--                     formControlName="password" required>-->
<!--              <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">-->
<!--                <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>-->
<!--              </button>-->
<!--            </mat-form-field>-->

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'security.users.one-time-password' | translate }}</mat-label>

              <input matInput
                     [type]="hidePassword ? 'password' : 'text'"
                     formControlName="password"
                     [required]="!editingUserId">

              <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">
                <mat-icon>{{ hidePassword ? 'visibility' : 'visibility_off' }}</mat-icon>
              </button>

              @if (!editingUserId && userForm.get('password')?.hasError('required')) {
                <mat-error>Password is required</mat-error>
              }
            </mat-form-field>


            <!-- Roles -->
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'security.users.roles' | translate }}</mat-label>
              <mat-select formControlName="roleIds" multiple>
                @for (role of roles; track role.id) {
                  <mat-option [value]="role.id">
                    {{ role.roleName }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <!-- Dialog Actions -->
            <div class="dialog-actions">
              <button mat-button type="button" (click)="closeDialog()" [disabled]="isSubmitting">
                {{ 'common.cancel' | translate }}
              </button>
<!--              <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting">-->
<!--                {{ 'common.save' | translate }}-->
<!--              </button>-->
              <button mat-raised-button color="primary" type="submit" [disabled]="isSubmitting">
                {{ 'common.save' | translate }}
              </button>

            </div>

          </form>
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>
